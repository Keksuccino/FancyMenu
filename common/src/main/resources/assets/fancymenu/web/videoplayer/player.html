<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FancyMenu Video Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body, html {
            width: 100%;
            height: 100%;
            background-color: #000000;
        }

        #videoContainer {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* When fillScreen is enabled */
        .fill-screen video {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }

        #debugInfo {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: #00ff00;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            font-family: monospace;
            font-size: 12px;
            z-index: 100;
        }
        
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: sans-serif;
            text-align: center;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="videoPlayer" playsinline></video>
    </div>
    
    <div id="loader">
        <div class="spinner"></div>
        <div id="loaderText">Loading video...</div>
    </div>
    
    <div id="debugInfo"></div>

    <script>
        // Log function that also shows on screen
        function log(message) {
            console.log(message);
            
            // Make sure debugInfo element exists
            if (!document.getElementById('debugInfo')) {
                const debugDiv = document.createElement('div');
                debugDiv.id = 'debugInfo';
                debugDiv.style.position = 'absolute';
                debugDiv.style.bottom = '10px';
                debugDiv.style.left = '10px';
                debugDiv.style.color = '#00ff00';
                debugDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                debugDiv.style.padding = '5px';
                debugDiv.style.fontFamily = 'monospace';
                debugDiv.style.fontSize = '12px';
                debugDiv.style.zIndex = '100';
                document.body.appendChild(debugDiv);
            }
            
            const debugInfo = document.getElementById('debugInfo');
            if (debugInfo) {
                const time = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `<div>[${time}] ${message}</div>`;
                // Keep only last 10 messages
                const lines = debugInfo.getElementsByTagName('div');
                if (lines.length > 10) {
                    debugInfo.removeChild(lines[0]);
                }
            }
        }
        
        // Ensure all required elements exist
        function ensureElementsExist() {
            // Ensure video container exists
            if (!document.getElementById('videoContainer')) {
                const container = document.createElement('div');
                container.id = 'videoContainer';
                container.style.width = '100%';
                container.style.height = '100%';
                container.style.display = 'flex';
                container.style.justifyContent = 'center';
                container.style.alignItems = 'center';
                container.style.position = 'relative';
                document.body.appendChild(container);
                log("Created missing videoContainer element");
            }
            
            // Ensure video player exists
            if (!document.getElementById('videoPlayer')) {
                const videoElement = document.createElement('video');
                videoElement.id = 'videoPlayer';
                videoElement.setAttribute('playsinline', '');
                videoElement.setAttribute('webkit-playsinline', '');
                document.getElementById('videoContainer').appendChild(videoElement);
                log("Created missing videoPlayer element");
                
                // Setup initial settings for newly created video element
                videoElement.volume = initialVolume;
                videoElement.loop = initialLoop;
                videoElement.controls = false;
                videoElement.autoplay = autoPlay;
            }
            
            // Ensure loader exists
            if (!document.getElementById('loader')) {
                const loader = document.createElement('div');
                loader.id = 'loader';
                loader.style.position = 'absolute';
                loader.style.top = '50%';
                loader.style.left = '50%';
                loader.style.transform = 'translate(-50%, -50%)';
                loader.style.color = 'white';
                loader.style.fontFamily = 'sans-serif';
                loader.style.textAlign = 'center';
                
                const spinner = document.createElement('div');
                spinner.className = 'spinner';
                spinner.style.width = '40px';
                spinner.style.height = '40px';
                spinner.style.margin = '0 auto';
                spinner.style.border = '4px solid rgba(255, 255, 255, 0.3)';
                spinner.style.borderRadius = '50%';
                spinner.style.borderTop = '4px solid white';
                spinner.style.animation = 'spin 1s linear infinite';
                
                const loaderText = document.createElement('div');
                loaderText.id = 'loaderText';
                loaderText.textContent = 'Loading video...';
                
                loader.appendChild(spinner);
                loader.appendChild(loaderText);
                document.body.appendChild(loader);
                log("Created missing loader element");
                
                // Add keyframe animation for spinner
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            return {
                videoContainer: document.getElementById('videoContainer'),
                videoPlayer: document.getElementById('videoPlayer'),
                loader: document.getElementById('loader'),
                loaderText: document.getElementById('loaderText')
            };
        }
        
        // Call function to ensure all elements exist
        const elements = ensureElementsExist();
        const videoContainer = elements.videoContainer;
        const videoPlayer = elements.videoPlayer;
        const loader = elements.loader;
        const loaderText = elements.loaderText;
        
        // Initialize variables
        let videoSource = '';
        let videoBlob = null;
        
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialVolume = parseFloat(urlParams.get('volume')) || 1.0;
        const initialLoop = urlParams.get('loop') === 'true';
        const initialFillScreen = urlParams.get('fillScreen') === 'true';
        const autoPlay = urlParams.get('autoPlay') !== 'false'; // Default to true
        const videoPath = urlParams.get('video') || '';
        
        // Setup player with initial settings
        videoPlayer.volume = initialVolume;
        videoPlayer.loop = initialLoop;
        videoPlayer.controls = false; // Hide controls by default
        videoPlayer.autoplay = autoPlay;
        
        // Set fill screen mode if enabled
        if (initialFillScreen) {
            videoContainer.classList.add('fill-screen');
        }
        
        // Functions to load files in different ways
        
        // Method 1: Direct src attribute (works for some videos)
        function loadVideoDirectly(path) {
            log(`Loading video directly: ${path}`);
            videoPlayer.src = path;
            videoPlayer.load();
        }
        
        // Method 2: XHR + Blob approach (works for local files)
        function loadVideoAsBlob(path) {
            log(`Loading video as blob: ${path}`);
            
            // Show loader
            loader.style.display = 'block';
            loaderText.textContent = 'Loading video...';
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', path, true);
            xhr.responseType = 'blob';
            
            xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    loaderText.textContent = `Loading video: ${percentComplete}%`;
                    log(`Loading progress: ${percentComplete}%`);
                }
            };
            
            xhr.onload = function() {
                if (this.status === 200) {
                    // Release previous blob
                    if (videoBlob) {
                        URL.revokeObjectURL(videoPlayer.src);
                    }
                    
                    // Create blob URL
                    videoBlob = this.response;
                    const blobUrl = URL.createObjectURL(videoBlob);
                    log(`Created blob URL: ${blobUrl}`);
                    
                    // Set video source
                    videoPlayer.src = blobUrl;
                    videoPlayer.load();
                    
                    // Attempt to play
                    if (autoPlay) {
                        tryPlayVideo();
                    }
                } else {
                    log(`XHR failed with status: ${this.status}`);
                    loaderText.textContent = `Error: Failed to load video (status ${this.status})`;
                }
            };
            
            xhr.onerror = function() {
                log('XHR network error');
                loaderText.textContent = 'Error: Network error loading video';
                
                // Try direct loading as fallback
                log('Trying direct loading as fallback');
                loadVideoDirectly(path);
            };
            
            xhr.send();
        }
        
        // Try multiple methods to play video (for autoplay policies)
        function tryPlayVideo() {
            log('Attempting to play video...');
            
            // First try to play normally
            videoPlayer.play().then(() => {
                log('Video playback started successfully');
                // Store the playing state
                if (window.videoPlayerAPI) {
                    window.videoPlayerAPI.currentSettings.playing = true;
                }
            }).catch(e => {
                log(`Standard play failed: ${e.message}`);
                
                // Try with muted (browsers often allow muted autoplay)
                log('Trying muted playback...');
                videoPlayer.muted = true;
                videoPlayer.play().then(() => {
                    log('Muted playback started successfully');
                    // Unmute after a short delay (browsers often allow if user already interacted)
                    setTimeout(() => {
                        if (window.videoPlayerAPI && !window.videoPlayerAPI.currentSettings.muted) {
                            log('Attempting to unmute after successful autoplay');
                            videoPlayer.muted = false;
                        }
                    }, 1000);
                    
                    // Store the playing state
                    if (window.videoPlayerAPI) {
                        window.videoPlayerAPI.currentSettings.playing = true;
                    }
                }).catch(e2 => {
                    log(`Muted play also failed: ${e2.message}`);
                    
                    // As a last resort, try to play inline
                    videoPlayer.setAttribute('playsinline', '');
                    videoPlayer.setAttribute('webkit-playsinline', '');
                    videoPlayer.play().catch(e3 => {
                        log(`All play attempts failed: ${e3.message}`);
                    });
                });
            });
        }
        
        // Main load function that decides which method to use
        function loadVideo(path) {
            if (!path) {
                log('No video path provided');
                return;
            }
            
            // Store the current source
            videoSource = path;
            log(`Loading video from path: ${path}`);
            
            // Show loader
            loader.style.display = 'block';
            
            // For local file paths, use the blob approach
            if (path.startsWith('file://')) {
                loadVideoAsBlob(path);
            } else {
                // For other URLs, try direct loading
                loadVideoDirectly(path);
                
                // If direct loading doesn't work after a short time, try blob approach
                setTimeout(function() {
                    if (!videoPlayer.duration && videoPlayer.readyState < 2) {
                        log('Direct loading not working, trying blob approach');
                        loadVideoAsBlob(path);
                    }
                }, 2000);
            }
        }
        
        // Functions that can be called from Java
        window.videoPlayerAPI = {
            // Store current settings so they can be applied to new videos
            currentSettings: {
                volume: initialVolume,
                loop: initialLoop,
                fillScreen: initialFillScreen,
                muted: false,
                playing: autoPlay // Track initial play state
            },
            
            loadVideo: function(path) {
                log(`API called: loadVideo(${path})`);
                loadVideo(path);
                return true;
            },
            
            play: function() {
                log('API called: play()');
                
                // Use this to track if we need to play after loading
                this.currentSettings.playing = true;
                
                // Try multiple methods to play
                tryPlayVideo();
                return true;
            },
            
            pause: function() {
                log('API called: pause()');
                videoPlayer.pause();
                return true;
            },
            
            stop: function() {
                log('API called: stop()');
                videoPlayer.pause();
                videoPlayer.currentTime = 0;
                return true;
            },
            
            setVolume: function(volume) {
                volume = Math.max(0, Math.min(1, volume));
                log(`API called: setVolume(${Math.round(volume * 100)}%)`);
                // Store the setting for future videos
                this.currentSettings.volume = volume;
                videoPlayer.volume = volume;
                return true;
            },
            
            getVolume: function() {
                return this.currentSettings.volume;
            },
            
            setLoop: function(shouldLoop) {
                log(`API called: setLoop(${shouldLoop})`);
                // Store the setting for future videos
                this.currentSettings.loop = shouldLoop;
                videoPlayer.loop = shouldLoop;
                return true;
            },
            
            isLooping: function() {
                return this.currentSettings.loop;
            },
            
            setFillScreen: function(shouldFill) {
                log(`API called: setFillScreen(${shouldFill})`);
                // Store the setting for future videos
                this.currentSettings.fillScreen = shouldFill;
                if (shouldFill) {
                    videoContainer.classList.add('fill-screen');
                } else {
                    videoContainer.classList.remove('fill-screen');
                }
                return true;
            },
            
            isFillScreen: function() {
                return this.currentSettings.fillScreen;
            },
            
            getDuration: function() {
                return videoPlayer.duration || 0;
            },
            
            getCurrentTime: function() {
                return videoPlayer.currentTime || 0;
            },
            
            setCurrentTime: function(time) {
                try {
                    log(`API called: setCurrentTime(${time})`);
                    
                    // Make sure we have a valid time
                    time = Math.max(0, time);
                    
                    if (videoPlayer.readyState === 0) {
                        log("Warning: Video not ready yet, seeking may fail");
                    }
                    
                    // Store original time in case of error
                    const originalTime = videoPlayer.currentTime;
                    
                    // Set the time
                    videoPlayer.currentTime = time;
                    
                    // Verify the time was actually set (some browsers restrict seeking)
                    setTimeout(() => {
                        if (Math.abs(videoPlayer.currentTime - time) > 0.5 && 
                            Math.abs(videoPlayer.currentTime - originalTime) < 0.1) {
                            log(`Seek verification failed. Target: ${time}, Actual: ${videoPlayer.currentTime}`);
                        }
                    }, 50);
                    
                    return true;
                } catch (e) {
                    log(`Error setting time: ${e.message}`);
                    return false;
                }
            },
            
            getMuted: function() {
                return this.currentSettings.muted;
            },
            
            setMuted: function(muted) {
                log(`API called: setMuted(${muted})`);
                // Store the setting for future videos
                this.currentSettings.muted = muted;
                videoPlayer.muted = muted;
                return true;
            },
            
            isPlaying: function() {
                return !videoPlayer.paused;
            },
            
            getVideoWidth: function() {
                return videoPlayer.videoWidth;
            },
            
            getVideoHeight: function() {
                return videoPlayer.videoHeight;
            },
            
            // Function to notify Java about play state changes
            notifyPlayStateChange: function(isPlaying) {
                // This is just a placeholder - the real communication 
                // happens by Java polling the isPlaying() method
                log(`Play state changed: ${isPlaying ? 'playing' : 'paused/stopped'}`);
                this.currentSettings.playing = isPlaying;
                return true;
            }
        };
        
        // Event listeners for video player
        videoPlayer.addEventListener('loadedmetadata', function() {
            log(`Video metadata loaded: ${videoPlayer.videoWidth}x${videoPlayer.videoHeight}`);
            // Hide loader once metadata is loaded
            loader.style.display = 'none';
            
            // Apply current player settings to the new video
            applyStoredSettings();
            
            // Try to play if autoplay is enabled
            if (autoPlay || (window.videoPlayerAPI && window.videoPlayerAPI.currentSettings.playing)) {
                log('Auto-playing video on loadedmetadata event');
                tryPlayVideo();
            }
        });
        
        videoPlayer.addEventListener('canplay', function() {
            log('Video can play now');
            // Hide loader
            loader.style.display = 'none';
            
            // Apply settings one more time to be sure
            applyStoredSettings();
            
            // If autoplay is enabled or API requested play
            if (autoPlay || (window.videoPlayerAPI && window.videoPlayerAPI.currentSettings.playing)) {
                log('Auto-playing video on canplay event');
                tryPlayVideo();
            }
        });
        
        videoPlayer.addEventListener('playing', function() {
            log('Video started playing');
            // Hide loader
            loader.style.display = 'none';
            // Update the playing state in the API
            if (window.videoPlayerAPI) {
                window.videoPlayerAPI.currentSettings.playing = true;
                // Send a message to Java about the play state change
                window.videoPlayerAPI.notifyPlayStateChange(true);
            }
        });
        
        videoPlayer.addEventListener('pause', function() {
            log('Video paused');
            // Update the playing state in the API
            if (window.videoPlayerAPI) {
                window.videoPlayerAPI.currentSettings.playing = false;
                // Send a message to Java about the play state change
                window.videoPlayerAPI.notifyPlayStateChange(false);
            }
        });
        
        // Function to apply all stored settings to the video element
        function applyStoredSettings() {
            if (!window.videoPlayerAPI || !window.videoPlayerAPI.currentSettings) {
                log('No stored settings found, using defaults');
                return;
            }
            
            // Get current settings from stored settings object
            const settings = window.videoPlayerAPI.currentSettings;
            log(`Applying stored settings to new video: volume=${settings.volume}, loop=${settings.loop}, fillScreen=${settings.fillScreen}, muted=${settings.muted}`);
            
            // Apply all settings
            videoPlayer.volume = settings.volume;
            videoPlayer.loop = settings.loop;
            videoPlayer.muted = settings.muted;
            
            // Apply fillScreen setting
            if (settings.fillScreen) {
                videoContainer.classList.add('fill-screen');
            } else {
                videoContainer.classList.remove('fill-screen');
            }
        }
        
        videoPlayer.addEventListener('waiting', function() {
            log('Video buffering...');
            // Show loader while buffering
            loader.style.display = 'block';
            loaderText.textContent = 'Buffering...';
        });
        
        videoPlayer.addEventListener('ended', function() {
            log('Video ended');
            // Update the playing state in the API unless looping
            if (window.videoPlayerAPI) {
                if (!videoPlayer.loop) {
                    window.videoPlayerAPI.currentSettings.playing = false;
                    // Send a message to Java about the play state change
                    window.videoPlayerAPI.notifyPlayStateChange(false);
                }
            }
        });
        
        videoPlayer.addEventListener('error', function(e) {
            // Show error details
            let errorMessage = "Unknown error";
            
            if (videoPlayer.error) {
                switch(videoPlayer.error.code) {
                    case 1: errorMessage = "Video loading aborted"; break;
                    case 2: errorMessage = "Network error"; break;
                    case 3: errorMessage = "Video decoding failed"; break;
                    case 4: errorMessage = "Video format not supported"; break;
                }
                
                errorMessage += ` (${videoPlayer.error.code})`;
            }
            
            log(`Video error: ${errorMessage}`);
            loader.style.display = 'block';
            loaderText.textContent = `Error: ${errorMessage}`;
            
            // Try to provide more detailed error info
            const videoSrc = videoPlayer.currentSrc || videoSource || "(unknown)";
            log(`Source: ${videoSrc}`);
        });
        
        // Load video if provided in URL
        if (videoPath) {
            log(`Initial video from URL param: ${videoPath}`);
            loadVideo(videoPath);
            
            // Set initial playing state correctly for autoplay
            if (window.videoPlayerAPI) {
                window.videoPlayerAPI.currentSettings.playing = autoPlay;
            }
        } else {
            log('No initial video provided');
        }
        
        // Log initial settings
        log('FancyMenu Video Player initialized');
        log(`Volume: ${Math.round(initialVolume * 100)}%`);
        log(`Loop: ${initialLoop}`);
        log(`Fill screen: ${initialFillScreen}`);
        log(`Autoplay: ${autoPlay}`);
    </script>
</body>
</html>